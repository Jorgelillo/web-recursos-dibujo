---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import { Image } from 'astro:assets';

export async function getStaticPaths() {
  const tareas = await getCollection('tareas');
  return tareas.map(entry => ({
    params: { slug: entry.slug },
    props: { tarea: entry },
  }));
}

const { tarea } = Astro.props;
const { Content } = await tarea.render();
---

<Layout title={tarea.data.titulo}>
  <article class="container mx-auto p-4 max-w-4xl relative">
    <a href={`/asignaturas/${tarea.data.asignatura}`} class="inline-flex items-center gap-2 text-indigo-600 hover:text-indigo-800 font-medium mb-6 transition">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
      </svg>
      Volver a la asignatura
    </a>
    
    <h1 class="text-4xl md:text-5xl font-bold mb-4 text-gray-900">{tarea.data.titulo}</h1>
    
    <div class="flex flex-wrap gap-4 text-sm text-gray-600 mb-10 pb-6 border-b border-gray-100">
        <span class="flex items-center gap-1 bg-gray-100 px-3 py-1 rounded-full">
             {tarea.data.fecha.toLocaleDateString()}
        </span>
        <span class="flex items-center gap-1 bg-pink-50 text-pink-700 px-3 py-1 rounded-full font-medium">
             {tarea.data.tecnica || 'Variada'}
        </span>
    </div>



    {tarea.data.etiquetas && tarea.data.etiquetas.length > 0 && (
      <div class="flex flex-wrap gap-2 mb-8">
        {tarea.data.etiquetas.map(tag => (
          <a href={`/etiquetas/${tag.toLowerCase()}`} class="bg-gray-100 hover:bg-indigo-100 text-gray-600 hover:text-indigo-700 px-4 py-1.5 rounded-full text-sm font-medium transition duration-200">
            #{tag}
          </a>
        ))}
      </div>
    )}

    {tarea.data.pdfAdjunto && (
      <div class="mb-10 p-6 bg-indigo-50 border border-indigo-100 rounded-2xl flex flex-col sm:flex-row items-center justify-between gap-4">
        <div>
          <h3 class="text-lg font-bold text-indigo-900">Material Descargable</h3>
          <p class="text-indigo-700 text-sm mt-1">Descarga e imprime esta ficha para trabajarla en clase o en casa.</p>
        </div>
        <a 
          href={tarea.data.pdfAdjunto} 
          download
          target="_blank"
          rel="noopener noreferrer"
          class="shrink-0 inline-flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl shadow-sm hover:shadow-md transition-all transform hover:-translate-y-1"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          Descargar Ficha en PDF
        </a>
      </div>
    )}

    <div class="prose prose-lg max-w-none mb-16 text-gray-700 prose-headings:text-gray-900 prose-a:text-indigo-600">
        <Content />
    </div>

    {tarea.data.ejemplosAlumnos && tarea.data.ejemplosAlumnos.length > 0 && (
        <section class="bg-gray-50 -mx-4 px-4 py-12 sm:rounded-3xl sm:px-12">
            <div class="text-center mb-10">
                <h2 class="text-3xl font-bold text-gray-900 mb-2">Trabajos de Alumnos</h2>
                <p class="text-gray-500">Haz clic en las im谩genes para ver los detalles</p>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                {tarea.data.ejemplosAlumnos.map((imgAlumno, index) => (
                    <figure class="cursor-zoom-in lightbox-trigger group overflow-hidden rounded-xl shadow-sm bg-white" data-src={imgAlumno.src}>
                        <Image 
                            src={imgAlumno} 
                            alt={`Ejemplo de alumno ${index + 1}`} 
                            class="w-full h-64 object-cover group-hover:scale-105 transition duration-500 ease-in-out"
                        />
                    </figure>
                ))}
            </div>
        </section>
    )}
  </article>

<div id="lightbox" class="fixed inset-0 z-[100] bg-gray-900/95 hidden grid place-items-center p-4 sm:p-8 backdrop-blur-sm opacity-0 transition-opacity duration-300">
    
    <button id="lightbox-close" class="absolute top-4 right-4 sm:top-8 sm:right-8 text-white/70 hover:text-white text-5xl font-light transition w-12 h-12 flex items-center justify-center rounded-full hover:bg-white/10 z-10">
      &times;
    </button>
    
    <img id="lightbox-img" src="" alt="Imagen ampliada" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl scale-95 transition-transform duration-300" />

</div>
</Layout>

<script>
  // Ejecutamos el c贸digo directamente
  const triggers = document.querySelectorAll('.lightbox-trigger');
  const lightbox = document.getElementById('lightbox');
  const lightboxImg = document.getElementById('lightbox-img');
  const closeBtn = document.getElementById('lightbox-close');

  if (triggers.length > 0 && lightbox && lightboxImg && closeBtn) {
      
      // Funci贸n para cerrar
      const closeLightbox = () => {
          lightbox.classList.add('opacity-0');
          lightboxImg.classList.remove('scale-100');
          lightboxImg.classList.add('scale-95');
          
          // Esperar a que acabe la animaci贸n
          setTimeout(() => {
              lightbox.classList.add('hidden');
              lightboxImg.setAttribute('src', '');
              document.body.style.overflow = ''; // Restaurar scroll
          }, 300);
      };

      // Funci贸n para abrir
      triggers.forEach(trigger => {
          trigger.addEventListener('click', () => {
              const src = trigger.getAttribute('data-src');
              if (src) {
                  lightboxImg.setAttribute('src', src);
                  lightbox.classList.remove('hidden');
                  
                  // Peque帽o retraso para la animaci贸n
                  requestAnimationFrame(() => {
                      lightbox.classList.remove('opacity-0');
                      lightboxImg.classList.remove('scale-95');
                      lightboxImg.classList.add('scale-100');
                  });
                  document.body.style.overflow = 'hidden'; // Quitar scroll de fondo
              }
          });
      });

      // Eventos de cierre
      closeBtn.addEventListener('click', closeLightbox);
      
      lightbox.addEventListener('click', (e) => {
          if (e.target === lightbox) closeLightbox(); 
      });
      
      document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && !lightbox.classList.contains('hidden')) {
              closeLightbox();
          }
      });
  }
</script>